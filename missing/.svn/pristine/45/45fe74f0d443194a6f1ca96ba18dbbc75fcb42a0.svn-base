package happylife.util.requestandresponse;

import happylife.model.TbWechatUser;
import happylife.util.MyX509TrustManager;
import happylife.util.StrUtil;
import happylife.util.XmlUtils;
import happylife.util.config.WeChatConfig;
import happylife.util.requestandresponse.messagebean.WeChatOauth2Token;
import happylife.util.requestandresponse.messagebean.WechatPayMsg;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.net.ConnectException;
import java.net.URL;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.text.SimpleDateFormat;
import java.util.Arrays;
import java.util.Date;
import java.util.Iterator;
import java.util.Map;
import java.util.Set;
import java.util.SortedMap;
import java.util.TreeMap;

import javax.net.ssl.HttpsURLConnection;
import javax.net.ssl.SSLContext;
import javax.net.ssl.SSLSocketFactory;
import javax.net.ssl.TrustManager;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.dom4j.Document;
import org.dom4j.DocumentException;
import org.dom4j.DocumentHelper;
import org.springframework.ui.ModelMap;

import com.alibaba.fastjson.JSONObject;

/**
 * é«˜çº§æ¥å£å·¥å…·ç±»
 * 
 * @author klaus
 * 
 */
public class WeChatRequestUtil {
	private static Log logger = LogFactory.getLog(WeChatRequestUtil.class);

	/**
	 * è·å–ç½‘é¡µæˆæƒå‡­è¯
	 * 
	 * @param appId
	 *            å…¬ä¼—è´¦å·çš„å”¯ä¸€æ ‡è¯†
	 * @param appSecret
	 *            å…¬ä¼—è´¦å·çš„å¯†é’¥
	 * @param code
	 * @return WeixinAouth2Token
	 */
	public static WeChatOauth2Token getOauth2AccessToken(String appId,
			String appSecret, String code) {
		WeChatOauth2Token wat = null;
		// æ‹¼æ¥è¯·æ±‚åœ°å€
		String requestUrl = WeChatConfig.WEIXIN_ACCESSTOKEN_URL;
		requestUrl = requestUrl.replace("APPID", appId);
		requestUrl = requestUrl.replace("SECRET", appSecret);
		requestUrl = requestUrl.replace("CODE", code);
		// è·å–ç½‘é¡µæˆæƒå‡­è¯
		JSONObject jsonObject = httpsRequest(requestUrl, "GET", null);
		if (null != jsonObject) {
			try {
				wat = new WeChatOauth2Token();
				wat.setAccessToken(jsonObject.getString("access_token"));
				wat.setExpiresIn(jsonObject.getIntValue("expires_in"));
				wat.setRefreshToken(jsonObject.getString("refresh_token"));
				wat.setOpenId(jsonObject.getString("openid"));
				wat.setScope(jsonObject.getString("scope"));
			} catch (Exception e) {
				wat = null;
				int errorCode = jsonObject.getIntValue("errcode");
				String errorMsg = jsonObject.getString("errmsg");
				logger.error("failed to getaccessToken errcode=" + errorCode
						+ ",errormessage=" + errorMsg);
			}
		}
		return wat;
	}

	/**
	 * åˆ·æ–°ç½‘é¡µæˆæƒå‡­è¯
	 * 
	 * @param appId
	 *            å…¬ä¼—è´¦å·çš„å”¯ä¸€æ ‡è¯†
	 * @param refreshToken
	 * @return WeixinAouth2Token
	 */
	public static WeChatOauth2Token refreshOauth2AccessToken(String appId,
			String refreshToken) {
		WeChatOauth2Token wat = null;
		// æ‹¼æ¥è¯·æ±‚åœ°å€
		String requestUrl = WeChatConfig.WEIXIN_REFRESHTOKEN_URL;
		requestUrl = requestUrl.replace("APPID", appId);
		requestUrl = requestUrl.replace("REFRESH_TOKEN", refreshToken);
		// åˆ·æ–°ç½‘é¡µæˆæƒå‡­è¯
		JSONObject jsonObject = httpsRequest(requestUrl, "GET", null);
		if (null != jsonObject) {
			try {
				wat = new WeChatOauth2Token();
				wat.setAccessToken(jsonObject.getString("access_token"));
				wat.setExpiresIn(jsonObject.getIntValue("expires_in"));
				wat.setRefreshToken(jsonObject.getString("refresh_token"));
				wat.setOpenId(jsonObject.getString("openid"));
				wat.setScope(jsonObject.getString("scope"));
			} catch (Exception e) {
				wat = null;
				int errorCode = jsonObject.getIntValue("errcode");
				String errorMsg = jsonObject.getString("errmsg");
				logger.error("failed to getaccessToken errcode=" + errorCode
						+ ",errormessage=" + errorMsg);
			}
		}
		return wat;
	}

	/**
	 * é€šè¿‡ç½‘é¡µæˆæƒè·å–ç”¨æˆ·ä¿¡æ¯
	 * 
	 * @param accessToken
	 *            ç½‘é¡µæˆæƒæ¥å£è°ƒç”¨å‡­è¯
	 * @param openId
	 *            ç”¨æˆ·æ ‡è¯†
	 * @return SNSUserInfo
	 */
	public static TbWechatUser getWeChatUserInfo(String accessToken,
			String openId) {
		// æ‹¼æ¥è¯·æ±‚åœ°å€
		String requestUrl = WeChatConfig.WEIXIN_GETUSER_URL;
		requestUrl = requestUrl.replace("ACCESS_TOKEN", accessToken).replace(
				"OPENID", openId);
		// é€šè¿‡ç½‘é¡µæˆæƒè·å–ç”¨æˆ·ä¿¡æ¯
		JSONObject jsonObject = httpsRequest(requestUrl, "GET", null);

		if (null != jsonObject) {
			try {
				TbWechatUser user = new TbWechatUser();
				user.setUserOpenid(jsonObject.getString("openid"));
				String nickname = jsonObject.getString("nickname").trim();
				nickname = new String(nickname.getBytes(), "utf-8");
				if (nickname.contains("ğŸ€")) {
					nickname = nickname.replaceAll("ğŸ€", "");
				}
				user.setUserNickName(nickname);
				String head = jsonObject.getString("headimgurl");
				if (head != null && !head.equals("")) {
					String headUrl = head.substring(0, head.length() - 1)
							+ "132";
					user.setUserHeadPath(headUrl);
				}
				user.setUserRegisterTime(new Date());
				
				boolean userSex = true;
				
				int sex = Integer.valueOf(jsonObject.getString("sex"));
				if(sex == 2){
					userSex =false;
				}
				
				user.setUserSex(userSex);
				return user;
			} catch (Exception e) {
				int errorCode = jsonObject.getIntValue("errcode");
				String errorMsg = jsonObject.getString("errmsg");
				logger.error("failed to getaccessToken errcode=" + errorCode
						+ ",errormessage=" + errorMsg);
			}
		}
		return null;
	}

	/**
	 * æ ¡éªŒå¾®ä¿¡ä¼ å…¥çš„signatureæ˜¯å¦æ­£ç¡®
	 * 
	 * @param signature
	 * @param timestamp
	 * @param nonce
	 * @return true OK ï¼Œfalse notOK
	 */
	public static boolean checkWeChatSignature(String signature,
			String timestamp, String nonce) {
		String[] arr = new String[] { WeChatConfig.WECHAT_TOKEN, timestamp,
				nonce };
		// å°†tokenã€timestampã€nonceä¸‰ä¸ªå‚æ•°è¿›è¡Œå­—å…¸åºæ’åº
		Arrays.sort(arr);
		StringBuilder content = new StringBuilder();
		for (int i = 0; i < arr.length; i++) {
			content.append(arr[i]);
		}
		MessageDigest md = null;
		String tmpStr = null;

		try {
			md = MessageDigest.getInstance("SHA-1");
			// å°†ä¸‰ä¸ªå‚æ•°å­—ç¬¦ä¸²æ‹¼æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²è¿›è¡Œsha1åŠ å¯†
			byte[] digest = md.digest(content.toString().getBytes());
			tmpStr = byteToStr(digest);
		} catch (NoSuchAlgorithmException e) {
			logger.error(e.getMessage());
			return false;
		}

		content = null;
		// å°†sha1åŠ å¯†åçš„å­—ç¬¦ä¸²å¯ä¸signatureå¯¹æ¯”ï¼Œæ ‡è¯†è¯¥è¯·æ±‚æ¥æºäºå¾®ä¿¡
		return tmpStr != null ? tmpStr.equals(signature.toUpperCase()) : false;

	}

	/**
	 * å°†å­—èŠ‚æ•°ç»„è½¬æ¢ä¸ºåå…­è¿›åˆ¶å­—ç¬¦
	 * 
	 * @param byteArray
	 * @return
	 */
	private static String byteToStr(byte[] byteArray) {
		String strDigest = "";
		for (int i = 0; i < byteArray.length; i++) {
			strDigest += byteToHexStr(byteArray[i]);
		}
		return strDigest;
	}

	/**
	 * å°†å•ä¸ªå­—èŠ‚è½¬æ¢ä¸ºåå…­è¿›åˆ¶å­—ç¬¦
	 * 
	 * @param mByte
	 * @return
	 */
	private static String byteToHexStr(byte mByte) {
		char[] Digit = { '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A',
				'B', 'C', 'D', 'E', 'F' };
		char[] tempArr = new char[2];
		tempArr[0] = Digit[(mByte >>> 4) & 0X0F]; // å–ä¸€ä¸ªå­—èŠ‚çš„é«˜4ä½ï¼Œç„¶åè·å¾—å…¶å¯¹åº”çš„åå…­è¿›åˆ¶å­—ç¬¦
		tempArr[1] = Digit[mByte & 0X0F]; // å–ä¸€ä¸ªå­—èŠ‚çš„ä½4ä½ï¼Œç„¶åè·å¾—å…¶å¯¹åº”çš„åå…­è¿›åˆ¶å­—ç¬¦

		return new String(tempArr);

	}

	/**
	 * å‘èµ·httpsè¯·æ±‚å¹¶è·å–ç»“æœ
	 * 
	 * @param requestUrl
	 *            è¯·æ±‚åœ°å€
	 * @param requestMethod
	 *            è¯·æ±‚æ–¹å¼ï¼ˆGETã€POSTï¼‰
	 * @param outputStr
	 *            æäº¤çš„æ•°æ®
	 * @return JSONObject(é€šè¿‡JSONObject.get(key)çš„æ–¹å¼è·å–jsonå¯¹è±¡çš„å±æ€§å€¼)
	 */
	public static JSONObject httpsRequest(String requestUrl,
			String requestMethod, String outputStr) {
		JSONObject jsonObject = null;
		try {
			System.setProperty("https.protocols", "TLSv1");
			// åˆ›å»ºSSLContextå¯¹è±¡ï¼Œå¹¶ä½¿ç”¨æˆ‘ä»¬æŒ‡å®šçš„ä¿¡ä»»ç®¡ç†å™¨åˆå§‹åŒ–
			TrustManager[] tm = { new MyX509TrustManager() };
			SSLContext sslContext = SSLContext.getInstance("SSL", "SunJSSE");
			sslContext.init(null, tm, new java.security.SecureRandom());
			// ä»ä¸Šè¿°SSLContextå¯¹è±¡ä¸­å¾—åˆ°SSLSocketFactoryå¯¹è±¡
			SSLSocketFactory ssf = sslContext.getSocketFactory();
			System.setProperty("jsse.enableSNIExtension", "false");
			URL url = new URL(requestUrl);
			HttpsURLConnection httpUrlConn = (HttpsURLConnection) url
					.openConnection();
			httpUrlConn.setSSLSocketFactory(ssf);

			httpUrlConn.setDoOutput(true);
			httpUrlConn.setDoInput(true);
			httpUrlConn.setUseCaches(false);
			// è®¾ç½®è¯·æ±‚æ–¹å¼ï¼ˆGET/POSTï¼‰
			httpUrlConn.setRequestMethod(requestMethod);

			if ("GET".equalsIgnoreCase(requestMethod))
				httpUrlConn.connect();

			// å½“æœ‰æ•°æ®éœ€è¦æäº¤æ—¶
			if (null != outputStr) {
				OutputStream outputStream = httpUrlConn.getOutputStream();
				// æ³¨æ„ç¼–ç æ ¼å¼ï¼Œé˜²æ­¢ä¸­æ–‡ä¹±ç 
				outputStream.write(outputStr.getBytes("UTF-8"));
				outputStream.close();
			}

			// å°†è¿”å›çš„è¾“å…¥æµè½¬æ¢æˆå­—ç¬¦ä¸²
			InputStream inputStream = httpUrlConn.getInputStream();
			String string = HttpUtil.changeInputStream(inputStream, "UTF-8");

			httpUrlConn.disconnect();
			jsonObject = JSONObject.parseObject(string);
		} catch (ConnectException ce) {
			ce.printStackTrace();
			logger.error(ce.getMessage());
		} catch (Exception e) {
			e.printStackTrace();
			logger.error(e.getMessage());
		}
		return jsonObject;
	}

	/**
	 * å‘èµ·httpsè¯·æ±‚å¹¶è·å–ç»“æœ
	 * 
	 * @param requestUrl
	 *            è¯·æ±‚åœ°å€
	 * @param requestMethod
	 *            è¯·æ±‚æ–¹å¼ï¼ˆGETã€POSTï¼‰
	 * @param outputStr
	 *            æäº¤çš„æ•°æ®
	 * @return JSONObject(é€šè¿‡JSONObject.get(key)çš„æ–¹å¼è·å–jsonå¯¹è±¡çš„å±æ€§å€¼)
	 * @throws ConnectException
	 */
	public static String httpsRequestString(String requestUrl,
			String requestMethod, String outputStr) throws ConnectException {
		JSONObject jsonObject = null;
		try {
			System.setProperty("https.protocols", "TLSv1");
			// åˆ›å»ºSSLContextå¯¹è±¡ï¼Œå¹¶ä½¿ç”¨æˆ‘ä»¬æŒ‡å®šçš„ä¿¡ä»»ç®¡ç†å™¨åˆå§‹åŒ–
			TrustManager[] tm = { new MyX509TrustManager() };
			SSLContext sslContext = SSLContext.getInstance("SSL", "SunJSSE");
			sslContext.init(null, tm, new java.security.SecureRandom());
			// ä»ä¸Šè¿°SSLContextå¯¹è±¡ä¸­å¾—åˆ°SSLSocketFactoryå¯¹è±¡
			SSLSocketFactory ssf = sslContext.getSocketFactory();
			System.setProperty("jsse.enableSNIExtension", "false");
			URL url = new URL(requestUrl);
			HttpsURLConnection httpUrlConn = (HttpsURLConnection) url
					.openConnection();
			httpUrlConn.setSSLSocketFactory(ssf);
			httpUrlConn.setDoOutput(true);
			httpUrlConn.setDoInput(true);
			httpUrlConn.setUseCaches(false);
			httpUrlConn.setConnectTimeout(100 * 1000);
			httpUrlConn.setReadTimeout(100 * 1000);
			httpUrlConn.setRequestProperty("Charsert", "UTF-8");
			// è®¾ç½®è¯·æ±‚æ–¹å¼ï¼ˆGET/POSTï¼‰
			httpUrlConn.setRequestMethod(requestMethod);

			if ("GET".equalsIgnoreCase(requestMethod))
				httpUrlConn.connect();
			// å½“æœ‰æ•°æ®éœ€è¦æäº¤æ—¶
			if (null != outputStr) {
				OutputStream outputStream = httpUrlConn.getOutputStream();
				// æ³¨æ„ç¼–ç æ ¼å¼ï¼Œé˜²æ­¢ä¸­æ–‡ä¹±ç 
				outputStream.write(outputStr.getBytes("UTF-8"));
				outputStream.close();
			}
			// å°†è¿”å›çš„è¾“å…¥æµè½¬æ¢æˆå­—ç¬¦ä¸²
			InputStream inputStream = httpUrlConn.getInputStream();
			BufferedReader reader = new BufferedReader(new InputStreamReader(
					inputStream));
			StringBuilder sb = new StringBuilder();
			String line = null;
			try {
				while ((line = reader.readLine()) != null) {
					sb.append(line);
				}
			} catch (IOException e) {
				e.printStackTrace();
			} finally {
				try {
					inputStream.close();
					httpUrlConn.disconnect();
				} catch (IOException e) {
					e.printStackTrace();
				}
			}
			return sb.toString();
		} catch (ConnectException ce) {
			ce.printStackTrace();
			logger.error(ce);
			throw ce;
		} catch (Exception e) {
			e.printStackTrace();
			logger.error(e);
		}
		return "";
	}

	/**
	 * å‘å¾®ä¿¡å¹³å°ç”³è¯·æ”¯ä»˜
	 * @param map  ç”¨äºå°è£… å¾®ä¿¡è¯·æ±‚çš„ model
	 * @param priceFen ï¼š å¾®ä¿¡äº¤æ˜“çš„ é‡‘é¢ï¼šå¿…é¡»æ˜¯ã€€åˆ†è¡¨ç¤ºçš„æ•´æ•°
	 * @param openIdã€€ã€€ï¼šå¾®ä¿¡ç”¨æˆ·çš„ã€€openId
	 * @param request  : http è¯·æ±‚
	 * @throws ConnectException
	 * @throws DocumentException
	 */
	public static void wechatPayRequest(ModelMap map,int priceFen,String openId,String out_trade_no,
			HttpServletRequest request) throws ConnectException, DocumentException {
		if(null == map || 0 == priceFen || null == openId || null ==request)
		{
			logger.error("paramet error");
			return ;
		}
		String flag = "";
	   //å•†æˆ·ç³»ç»Ÿå†…éƒ¨çš„è®¢å•å·,32 ä¸ªå­—ç¬¦å†…ã€å¯åŒ…å«å­—æ¯,ç¡®ä¿ åœ¨å•†æˆ·ç³»ç»Ÿå”¯ä¸€,è¯¦ç»†è¯´æ˜
	   	String attach = WeChatConfig.WECHAT_ATTACK;// ç”¨äºéªŒè¯æ˜¯ä»å¾®ä¿¡è¿‡æ¥çš„é“¾æ¥
		// å¾®ä¿¡æ”¯ä»˜
		String appid = WeChatConfig.APPID_WXPAY;
		String mch_id = WeChatConfig.MCH_ID;// å¾®ä¿¡æ”¯ä»˜åˆ†é…çš„å•†æˆ·å·
		String openid =  openId;//ç”¨æˆ·çš„openid
		String nonce_str = String.valueOf(new Date().getTime());// éšæœºå­—ç¬¦ä¸²ï¼Œä¸é•¿äº32
																// ä½
		String body = "product";
		String total_fee = String.valueOf(priceFen);// è®¢å•æ€»é‡‘é¢ï¼Œå•ä½ä¸ºåˆ†ï¼Œä¸ èƒ½å¸¦å°æ•°ç‚¹
		String spbill_create_ip = HttpUtil.getIpAddr(request);// è®¢å•ç”Ÿæˆçš„æœºå™¨IP
		String notify_url = WeChatConfig.WECHAT_NOTIFY_URL;// æ¥æ”¶å¾®ä¿¡æ”¯ä»˜æˆåŠŸé€šçŸ¥
		String trade_type = "JSAPI";// äº¤æ˜“ç±»å‹ JSAPIã€NATIVEã€APP
		String partnerKey = WeChatConfig.PARTNERKEY;// ç­¾åæ—¶ä¾¯ç”¨    å¾®ä¿¡å•†æˆ·å¹³å°(pay.weixin.qq.com)-->è´¦æˆ·ä¸­å¿ƒ-->è´¦æˆ·è®¾ç½®-->APIå®‰å…¨-->å¯†é’¥è®¾ç½®

		SortedMap<String, String> mp = new TreeMap<String, String>();
		mp.put("openid", openid);
		mp.put("body", body);
		mp.put("appid", appid);
		mp.put("out_trade_no", out_trade_no + "");
		mp.put("mch_id", mch_id);
		mp.put("nonce_str", nonce_str);
		mp.put("total_fee", total_fee);
		mp.put("notify_url", notify_url);
		mp.put("spbill_create_ip", spbill_create_ip);
		mp.put("trade_type", trade_type);
		mp.put("attach", attach);// é™„åŠ æ•°æ®ï¼ŒåŸæ ·è¿”å›:éªŒè¯æ˜¯å¦æ˜¯ä»å¾®ä¿¡æ”¯ä»˜å‘è¿‡æ¥çš„å•å­
		mp.put("sign", StrUtil.createSign(mp, partnerKey));
		String xml = "<xml>";
		Set<String> ss = mp.keySet();
		Iterator<String> iterator = ss.iterator();
		while (iterator.hasNext()) {
			String next = iterator.next();
			xml += ("<" + next + "><![CDATA[" + mp.get(next) + "]]></" + next + ">");
		}
		xml += "</xml>";
		flag = WeChatRequestUtil.httpsRequestString(
				WeChatConfig.UNIFIEDORDER_URL, "POST", xml);
		logger.info("the post xml="+xml+",flag="+flag);
		
		Document document = DocumentHelper.parseText(flag);
		Map<String, Object> mpt = XmlUtils.Dom2Map(document);
		String prepay_id = String.valueOf(mpt.get("prepay_id"));
		map.put("prepay_id", prepay_id);
		TreeMap<String, String> tmap = new TreeMap<String, String>();
		tmap.put("appId", appid);
		tmap.put("timeStamp", new Date().getTime() + "");
		tmap.put("nonceStr", StrUtil.getRandomString());
		tmap.put("package", "prepay_id=" + prepay_id);
		tmap.put("signType", "MD5");
		tmap.put("paySign", StrUtil.createSign(tmap, partnerKey));
		map.put("tmap", tmap);
	} 
	
	/** è§£æå¾®ä¿¡ è¿”å›ç»™ ç³»ç»Ÿçš„æ¶ˆæ¯
	 * @param request
	 * @return
	 * @throws Exception
	 */
	public static WechatPayMsg parseWxPayResponse(HttpServletRequest request)
			throws Exception {
		StringBuffer sb = new StringBuffer();
		InputStream is = request.getInputStream();
		InputStreamReader isr = new InputStreamReader(is);
		BufferedReader br = new BufferedReader(isr);
		String s = "";
		while ((s = br.readLine()) != null) {
			sb.append(s);
		}
		String str = sb.toString();
		Document document = DocumentHelper.parseText(str);
		Map<String, Object> mpt = XmlUtils.Dom2Map(document);
		String result_code = String.valueOf(mpt.get("result_code"));// æ˜¯å¦æ”¯ä»˜æˆåŠŸ
		String attach = String.valueOf(mpt.get("attach"));
		String out_trade_no = String.valueOf(mpt.get("out_trade_no"));// æ”¯ä»˜ID
		String transaction_id = String.valueOf(mpt.get("transaction_id"));// å¾®ä¿¡æ”¯ä»˜è®¢å•å·
		String sign_type = String.valueOf(mpt.get("sign_type"));
		String sign = String.valueOf(mpt.get("sign"));
		String trade_mode = String.valueOf(mpt.get("trade_mode"));
		String time_end = String.valueOf(mpt.get("time_end"));
		String total_fee = String.valueOf(mpt.get("total_fee"));
		String transport_fee = String.valueOf(mpt.get("transport_fee"));
		String product_fee = String.valueOf(mpt.get("product_fee"));

		Date nowtime = new Date();
		// /ä¿å­˜å¾®ä¿¡å‘é€è¿‡æ¥çš„è®¯æ¯
		WechatPayMsg wxmsg = new WechatPayMsg();
		wxmsg.setId(StrUtil.getUUID());
		wxmsg.setContent(str);
		wxmsg.setSign_type(sign_type);
		wxmsg.setSign(sign);
		wxmsg.setTrade_mode(trade_mode);
		wxmsg.setTrade_state(result_code);

		wxmsg.setTime_end(time_end);
		wxmsg.setTransaction_id(transaction_id);
		wxmsg.setTotal_fee(total_fee);
		wxmsg.setOut_trade_no(out_trade_no);
		wxmsg.setAttach(attach);
		wxmsg.setTransport_fee(transport_fee);
		wxmsg.setProduct_fee(product_fee);
		wxmsg.setTime(nowtime);
		return wxmsg;
	}
	
	
	/**
	 * é‡å®šå‘åˆ° é‰´æƒç•Œé¢
	 * 
	 * @param response
	 */
	public static  void redirectToAuthorize(HttpServletResponse response) {
		StringBuilder oauth_url = new StringBuilder();
		oauth_url
				.append("https://open.weixin.qq.com/connect/oauth2/authorize?");
		oauth_url.append("appid=").append(WeChatConfig.APP_ID);
		oauth_url.append("&redirect_uri=").append(
				WeChatConfig.WEBSITE_INDEX_URL+"/wechatuser/index");
		oauth_url.append("&response_type=code");
		oauth_url.append("&scope=snsapi_userinfo");
		oauth_url.append("&state=1#wechat_redirect");

		try {
			response.sendRedirect(oauth_url.toString());
		} catch (IOException e) {
			logger.error(e.getMessage());
		}
	
	}
	
	
	/**
	 * é‡å®šå‘åˆ°æŸä¸ªurl
	 * 
	 * @param response
	 */
	public static  void redirectToGivenUri(HttpServletResponse response ,String URL) {
		try {
			response.sendRedirect(URL);
		} catch (IOException e) {
			logger.error(e.getMessage());
		}
	}
	
	
}
